version: 1
name: finance.grir_with_tax_all.v2_strict.duckdb
description: >
  GR/IR with PO, GR, IR values and tax fields. By default (tax_policy=strict) the PO Tax Code and rate ONLY populate from real data (pricing elements or actual PO TaxCode). No silent defaults. Use tax_policy=defaults or infer to allow fallbacks.

params:
  vendor: ""
  vendor_query: ""
  po: ""
  plant: ""
  start_posting_date: ""
  end_posting_date: ""
  top: ""
  print_rows: 0

  # --- Tax behavior controls ---
  tax_policy: "strict" # strict | defaults | infer
  default_tax_code: "" # used only when tax_policy=defaults or infer
  default_tax_rate: "" # used only when tax_policy=defaults or infer (e.g., "18")
  tax_like_patterns: "IGST,CGST,SGST,UTGST,GST,VAT,MWST,J%,ZGST,SVAT"

steps:

# --- 1) PO Items + Header (NO $expand) -----------------------------------
- op: fetch
  name: po_items_raw
  source: sap
  service: API_PURCHASEORDER_PROCESS_SRV/A_PurchaseOrderItem
  query_params:
    $format: json
    $select: >
      PurchaseOrder,PurchaseOrderItem,Plant,Material,PurchaseOrderItemText, DocumentCurrency,OrderQuantity,NetPriceAmount,NetPriceQuantity,TaxCode
    $orderby: PurchaseOrder,PurchaseOrderItem

- op: fetch
  name: po_header_raw
  source: sap
  service: API_PURCHASEORDER_PROCESS_SRV/A_PurchaseOrder
  query_params:
    $format: json
    $select: PurchaseOrder,Supplier,DocumentCurrency,CompanyCode

# --- 2) Vendor & Company --------------------------------------------------
- op: fetch
  name: supplier_raw
  source: sap
  service: API_BUSINESS_PARTNER/A_Supplier
  query_params:
    $format: json
    $select: Supplier,SupplierName

- op: fetch
  name: bp_raw
  source: sap
  service: API_BUSINESS_PARTNER/A_BusinessPartner
  query_params:
    $format: json
    $select: BusinessPartner,BusinessPartnerName

- op: sql
  name: vendor_names
  sql: |
    WITH s AS (
      SELECT LPAD(CAST(Supplier AS VARCHAR),10,'0') AS Key10,
             NULLIF(SupplierName,'') AS SupplierName
      FROM supplier_raw
    ),
    b AS (
      SELECT LPAD(CAST(BusinessPartner AS VARCHAR),10,'0') AS Key10,
             MAX(NULLIF(BusinessPartnerName,'')) AS BPName
      FROM bp_raw
      GROUP BY 1
    )
    SELECT COALESCE(s.Key10,b.Key10) AS Key10,
           COALESCE(s.SupplierName,b.BPName) AS VendorName
    FROM s FULL OUTER JOIN b ON s.Key10 = b.Key10

- op: fetch
  name: company_raw
  source: sap
  service: API_COMPANYCODE_SRV/A_CompanyCode
  query_params:
    $format: json
    $select: CompanyCode,CompanyCodeName,Country

# --- 3) Pricing elements (read directly) ---------------------------------
- op: fetch
  name: pricing_raw
  source: sap
  service: API_PURCHASEORDER_PROCESS_SRV/A_PurOrdPricingElement
  query_params:
    $format: json
    $select: >
      PurchaseOrder,PurchaseOrderItem,ConditionType,ConditionAmount,ConditionCurrency

- op: sql
  name: pricing_tax_agg
  sql: |
    WITH patterns AS (
      SELECT TRIM(UPPER(x)) AS pat
      FROM UNNEST(STRING_SPLIT('{{ tax_like_patterns }}', ',')) AS t(x)
    ),
    pe AS (
      SELECT
        PurchaseOrder,
        PurchaseOrderItem,
        UPPER(COALESCE(ConditionType,'')) AS ct,
        ABS(TRY_CAST(ConditionAmount AS DOUBLE)) AS amt
      FROM pricing_raw
    )
    SELECT
      p.PurchaseOrder,
      p.PurchaseOrderItem,
      SUM(CASE
            WHEN EXISTS (SELECT 1 FROM patterns k WHERE p.ct LIKE REPLACE(k.pat, '%','%%'))
            THEN COALESCE(p.amt,0) ELSE 0
          END) AS pricing_tax_amount
    FROM pe p
    GROUP BY 1,2

# --- 4) Normalize PO item fields & resolve tax ----------------------------
- op: sql
  name: po_items
  sql: |
    WITH base AS (
      SELECT
        i.PurchaseOrder,
        i.PurchaseOrderItem,
        h.Supplier AS Vendor,
        COALESCE(i.DocumentCurrency, h.DocumentCurrency) AS PO_Currency,
        i.Plant,
        i.Material,
        i.PurchaseOrderItemText AS MaterialName,
        CAST(i.OrderQuantity    AS DOUBLE) AS po_qty,
        CAST(i.NetPriceAmount   AS DOUBLE) AS po_net_price_amount,
        CAST(i.NetPriceQuantity AS DOUBLE) AS po_net_price_quantity,
        NULLIF(UPPER(TRIM(i.TaxCode)),'') AS po_tax_code_raw
      FROM po_items_raw i
      LEFT JOIN po_header_raw h ON i.PurchaseOrder = h.PurchaseOrder
    ),
    code_rate_map AS (
      SELECT
        b.PurchaseOrder, b.PurchaseOrderItem, b.po_tax_code_raw,
        CASE
          WHEN b.po_tax_code_raw IN ('A0','V0','Y0','Z0','E0','EX','N1','NR','ZC') THEN 0.0
          WHEN b.po_tax_code_raw LIKE '%5'  OR b.po_tax_code_raw IN ('B5','I5','S5')   THEN 5.0
          WHEN b.po_tax_code_raw LIKE '%12' OR b.po_tax_code_raw IN ('B1','I1','S12')  THEN 12.0
          WHEN b.po_tax_code_raw LIKE '%18' OR b.po_tax_code_raw IN ('B2','I2','S18')  THEN 18.0
          WHEN b.po_tax_code_raw LIKE '%28' OR b.po_tax_code_raw IN ('B3','I3','S28')  THEN 28.0
          ELSE NULL
        END AS rate_from_code
      FROM base b
    ),
    joined AS (
      SELECT
        b.*,
        pta.pricing_tax_amount,
        crm.rate_from_code
      FROM base b
      LEFT JOIN pricing_tax_agg pta
        ON b.PurchaseOrder = pta.PurchaseOrder AND b.PurchaseOrderItem = pta.PurchaseOrderItem
      LEFT JOIN code_rate_map crm
        ON b.PurchaseOrder = crm.PurchaseOrder AND b.PurchaseOrderItem = crm.PurchaseOrderItem
    ),
    computed AS (
      SELECT
        j.*,
        CASE
          WHEN j.po_net_price_quantity IS NOT NULL AND j.po_net_price_quantity <> 0
            THEN j.po_net_price_amount / j.po_net_price_quantity
          WHEN j.po_qty IS NOT NULL AND j.po_qty <> 0
            THEN j.po_net_price_amount / j.po_qty
        END AS po_unit_price,
        CASE
          WHEN j.po_net_price_quantity IS NOT NULL AND j.po_net_price_quantity <> 0
            THEN j.po_qty * (j.po_net_price_amount / j.po_net_price_quantity)
          WHEN j.po_qty IS NOT NULL AND j.po_qty <> 0
            THEN j.po_qty * (j.po_net_price_amount / j.po_qty)
        END AS po_value
      FROM joined j
    ),
    rate_from_amount AS (
      SELECT
        c.*,
        CASE
          WHEN c.po_value IS NOT NULL AND c.po_value <> 0 AND c.pricing_tax_amount IS NOT NULL AND c.pricing_tax_amount <> 0
            THEN 100.0 * (c.pricing_tax_amount / c.po_value)
          ELSE NULL
        END AS rate_from_amount_pct
      FROM computed c
    ),
    policy AS (
      SELECT
        '{{ tax_policy }}'::VARCHAR AS mode,
        NULLIF(UPPER(TRIM('{{ default_tax_code }}')),'') AS def_code,
        TRY_CAST(NULLIF('{{ default_tax_rate }}','') AS DOUBLE) AS def_rate
    ),
    final_po AS (
      SELECT
        r.*,
        CASE
          WHEN (SELECT mode FROM policy) = 'strict'
            THEN COALESCE(r.rate_from_amount_pct, r.rate_from_code)
          WHEN (SELECT mode FROM policy) = 'defaults'
            THEN COALESCE(r.rate_from_amount_pct, r.rate_from_code, (SELECT def_rate FROM policy), 0.0)
          WHEN (SELECT mode FROM policy) = 'infer'
            THEN COALESCE(r.rate_from_amount_pct, r.rate_from_code, (SELECT def_rate FROM policy), 0.0)
          ELSE COALESCE(r.rate_from_amount_pct, r.rate_from_code)
        END AS final_rate_pct,
        CASE
          WHEN (SELECT mode FROM policy) = 'strict'
            THEN COALESCE(r.po_tax_code_raw, '')
          WHEN (SELECT mode FROM policy) = 'defaults'
            THEN COALESCE(r.po_tax_code_raw,
                          (SELECT def_code FROM policy),
                          '')
          WHEN (SELECT mode FROM policy) = 'infer'
            THEN COALESCE(
                   r.po_tax_code_raw,
                   CASE
                     WHEN ABS(COALESCE(r.rate_from_amount_pct, r.rate_from_code, (SELECT def_rate FROM policy), 0.0) - 0)  < 0.5 THEN 'A0'
                     WHEN ABS(COALESCE(r.rate_from_amount_pct, r.rate_from_code, (SELECT def_rate FROM policy), 0.0) - 5)  < 0.5 THEN 'B5'
                     WHEN ABS(COALESCE(r.rate_from_amount_pct, r.rate_from_code, (SELECT def_rate FROM policy), 0.0) - 12) < 0.5 THEN 'B1'
                     WHEN ABS(COALESCE(r.rate_from_amount_pct, r.rate_from_code, (SELECT def_rate FROM policy), 0.0) - 18) < 0.5 THEN 'B2'
                     WHEN ABS(COALESCE(r.rate_from_amount_pct, r.rate_from_code, (SELECT def_rate FROM policy), 0.0) - 28) < 0.5 THEN 'B3'
                     ELSE (SELECT def_code FROM policy)
                   END,
                   ''
                 )
          ELSE COALESCE(r.po_tax_code_raw, '')
        END AS final_code,
        CASE
          WHEN r.rate_from_amount_pct IS NOT NULL THEN 'PRICING'
          WHEN r.po_tax_code_raw IS NOT NULL THEN 'PO_CODE'
          WHEN (SELECT mode FROM policy) IN ('defaults','infer')
               AND COALESCE(r.rate_from_amount_pct, r.rate_from_code, (SELECT def_rate FROM policy)) IS NOT NULL
               AND COALESCE(r.rate_from_amount_pct, r.rate_from_code, (SELECT def_rate FROM policy)) <> 0
            THEN CASE WHEN (SELECT mode FROM policy)='infer' AND r.po_tax_code_raw IS NULL THEN 'INFERRED/DEFAULT'
                      WHEN (SELECT mode FROM policy)='defaults' THEN 'DEFAULT'
                 END
          ELSE 'NONE'
        END AS tax_source
      FROM rate_from_amount r
    )
    SELECT
      f.PurchaseOrder,
      f.PurchaseOrderItem,
      h.Supplier AS Vendor,
      vn.VendorName,
      h.CompanyCode,
      c.CompanyCodeName AS CompanyName,
      c.Country         AS CompanyCountry,
      i.Plant,
      i.Material,
      i.MaterialName,
      COALESCE(i.PO_Currency, h.DocumentCurrency) AS PO_Currency,
      i.po_qty,
      i.po_net_price_quantity,
      i.po_net_price_amount,
      i.po_unit_price,
      i.po_value,
      f.final_code          AS po_tax_code,
      f.final_rate_pct      AS resolved_tax_rate_pct,
      f.tax_source,
      i.pricing_tax_amount
    FROM final_po f
    JOIN computed i
      ON f.PurchaseOrder = i.PurchaseOrder AND f.PurchaseOrderItem = i.PurchaseOrderItem
    LEFT JOIN po_header_raw h ON i.PurchaseOrder = h.PurchaseOrder
    LEFT JOIN vendor_names vn ON LPAD(CAST(h.Supplier AS VARCHAR),10,'0') = vn.Key10
    LEFT JOIN company_raw c   ON h.CompanyCode = c.CompanyCode

    WHERE 1=1
      {%- if po != '' %}    AND i.PurchaseOrder = '{{ po }}' {%- endif %}
      {%- if plant != '' %} AND i.Plant = '{{ plant }}' {%- endif %}
      {%- if vendor != '' %} AND LPAD(CAST(h.Supplier AS VARCHAR),10,'0') = LPAD('{{ vendor }}',10,'0') {%- endif %}
      {%- if vendor_query != '' %} AND LOWER(vn.VendorName) LIKE '%' || LOWER('{{ vendor_query }}') || '%' {%- endif %}

# --- 5) GR Data -----------------------------------------------------------
- op: fetch
  name: gr_item_raw
  source: sap
  service: API_MATERIAL_DOCUMENT_SRV/A_MaterialDocumentItem
  query_params:
    $format: json
    $select: >
      MaterialDocument,MaterialDocumentYear,PurchaseOrder,PurchaseOrderItem, GoodsMovementType,GoodsMovementIsCancelled,QuantityInBaseUnit,Plant,Material

- op: fetch
  name: gr_header_raw
  source: sap
  service: API_MATERIAL_DOCUMENT_SRV/A_MaterialDocumentHeader
  query_params:
    $format: json
    $select: MaterialDocument,MaterialDocumentYear,PostingDate

- op: sql
  name: gr_valid
  sql: |
    SELECT
      gi.PurchaseOrder,
      gi.PurchaseOrderItem,
      TRY_CAST(gh.PostingDate AS DATE) AS PostingDate,
      CAST(gi.QuantityInBaseUnit AS DOUBLE) AS qty_gr,
      gi.MaterialDocument AS gr_number
    FROM gr_item_raw gi
    JOIN gr_header_raw gh
      ON gi.MaterialDocument = gh.MaterialDocument
     AND gi.MaterialDocumentYear = gh.MaterialDocumentYear
    WHERE gi.GoodsMovementIsCancelled = 'false'
      AND gi.GoodsMovementType IN ('101','103','105')
      {%- if start_posting_date != '' %} AND TRY_CAST(gh.PostingDate AS DATE) >= DATE '{{ start_posting_date }}' {%- endif %}
      {%- if end_posting_date   != '' %} AND TRY_CAST(gh.PostingDate AS DATE) <= DATE '{{ end_posting_date }}'   {%- endif %}

- op: sql
  name: gr_agg
  sql: |
    SELECT
      PurchaseOrder,
      PurchaseOrderItem,
      SUM(qty_gr) AS gr_qty,
      MAX(PostingDate) AS latest_gr_posting,
      MAX(gr_number) AS gr_number,
      CASE WHEN SUM(qty_gr) > 0 THEN 'Posted' ELSE 'Not Posted' END AS gr_status
    FROM gr_valid
    GROUP BY 1,2

# --- 6) IR Items (ex-tax totals only) -------------------------------------
- op: fetch
  name: ir_item_raw
  source: sap
  service: API_SUPPLIERINVOICE_PROCESS_SRV/A_SuplrInvcItemPurOrdRef
  query_params:
    $format: json
    $select: >
      SupplierInvoice,FiscalYear,PurchaseOrder,PurchaseOrderItem, SupplierInvoiceItemAmount,QuantityInPurchaseOrderUnit,DocumentCurrency

- op: fetch
  name: ir_header_raw
  source: sap
  service: API_SUPPLIERINVOICE_PROCESS_SRV/A_SupplierInvoice
  query_params:
    $format: json
    $select: SupplierInvoice,FiscalYear,PostingDate,CompanyCode

- op: sql
  name: ir_agg
  sql: |
    SELECT
      ii.PurchaseOrder,
      ii.PurchaseOrderItem,
      MAX(ih.CompanyCode) AS company_code,
      MAX(ii.SupplierInvoice) AS ir_number,
      SUM(CAST(ii.QuantityInPurchaseOrderUnit AS DOUBLE)) AS ir_qty,
      SUM(CAST(ii.SupplierInvoiceItemAmount AS DOUBLE))   AS ir_value_ex_tax,
      MAX(TRY_CAST(ih.PostingDate AS DATE)) AS latest_ir_posting,
      CASE WHEN SUM(CAST(ii.QuantityInPurchaseOrderUnit AS DOUBLE)) > 0 THEN 'Posted' ELSE 'Not Posted' END AS invoice_status
    FROM ir_item_raw ii
    JOIN ir_header_raw ih
      ON ii.SupplierInvoice = ih.SupplierInvoice
     AND ii.FiscalYear      = ih.FiscalYear
    WHERE 1=1
      {%- if start_posting_date != '' %} AND TRY_CAST(ih.PostingDate AS DATE) >= DATE '{{ start_posting_date }}' {%- endif %}
      {%- if end_posting_date   != '' %} AND TRY_CAST(ih.PostingDate AS DATE) <= DATE '{{ end_posting_date }}'   {%- endif %}
    GROUP BY 1,2

# --- 7) Result: GR without IR (tax impact view) ---------------------------
- op: sql
  name: result
  sql: |
    WITH enriched AS (
      SELECT
        p.*,
        COALESCE(
          CASE
            WHEN p.po_net_price_quantity IS NOT NULL AND p.po_net_price_quantity <> 0
              THEN p.po_net_price_amount / p.po_net_price_quantity
            WHEN p.po_qty IS NOT NULL AND p.po_qty <> 0
              THEN p.po_net_price_amount / p.po_qty
          END
        ) AS unit_price_safe
      FROM po_items p
    )
    SELECT
      p.CompanyCode                         AS "Company Code",
      c.CompanyCodeName                     AS "Company Name",
      i.Plant                               AS "Plant",
      p.Vendor                              AS "Vendor",
      vn.VendorName                         AS "Vendor Name",
      i.PurchaseOrder                       AS "PO Number",
      i.PurchaseOrderItem                   AS "PO Item",
      i.Material                            AS "Material",
      i.MaterialName                        AS "Material Name",
      COALESCE(i.PO_Currency, h.DocumentCurrency) AS "Currency",

      i.po_qty                              AS "PO Qty",
      i.po_net_price_quantity               AS "PO NetPriceQuantity",
      i.po_net_price_amount                 AS "PO NetPriceAmount",
      i.unit_price_safe                     AS "PO Unit Price",
      i.po_value                            AS "PO Value (ex-tax)",

      COALESCE(g.gr_qty,0)                  AS "GR Qty",
      CASE WHEN i.unit_price_safe IS NOT NULL
           THEN COALESCE(g.gr_qty,0) * i.unit_price_safe
      END                                   AS "GR Value (ex-tax)",

      COALESCE(ir.ir_qty,0)                 AS "IR Qty",
      COALESCE(ir.ir_value_ex_tax,0)        AS "IR Value (ex-tax)",

      (COALESCE(g.gr_qty,0) - COALESCE(ir.ir_qty,0)) AS "Qty Diff",
      (COALESCE(ir.ir_value_ex_tax,0) - i.po_value)  AS "Diff ex-tax",
      ROUND(((COALESCE(ir.ir_value_ex_tax,0)/NULLIF(i.po_value,0))-1)*100,2) AS "IR vs PO % Over (ex-tax)",

      g.gr_status                           AS "GR Status",
      COALESCE(ir.invoice_status,'Not Posted') AS "IR Status",
      g.gr_number                           AS "GR Number",
      COALESCE(ir.ir_number,'')             AS "IR Number",
      g.latest_gr_posting                   AS "GR Posting Date",
      ir.latest_ir_posting                  AS "Invoice Posting Date",

      -- Tax (impact is the GR tax since IR not posted)
      p.po_tax_code                         AS "PO Tax Code",
      p.resolved_tax_rate_pct               AS "Tax Rate (%)",
      CASE WHEN i.unit_price_safe IS NOT NULL
           THEN (COALESCE(g.gr_qty,0) * i.unit_price_safe) * (p.resolved_tax_rate_pct / 100.0)
           ELSE NULL
      END                                   AS "GR Tax Value"
    FROM enriched i
    JOIN po_items p  ON i.PurchaseOrder = p.PurchaseOrder AND i.PurchaseOrderItem = p.PurchaseOrderItem
    LEFT JOIN gr_agg g  ON i.PurchaseOrder = g.PurchaseOrder AND i.PurchaseOrderItem = g.PurchaseOrderItem
    LEFT JOIN ir_agg ir ON i.PurchaseOrder = ir.PurchaseOrder AND i.PurchaseOrderItem = ir.PurchaseOrderItem
    LEFT JOIN po_header_raw h ON i.PurchaseOrder = h.PurchaseOrder
    LEFT JOIN vendor_names vn ON LPAD(CAST(p.Vendor AS VARCHAR),10,'0') = vn.Key10
    LEFT JOIN company_raw c   ON p.CompanyCode = c.CompanyCode

    WHERE g.gr_status = 'Posted'
      AND COALESCE(ir.invoice_status,'Not Posted') = 'Not Posted'
      -- Optional: also ensure no IR quantity/value at all
      AND COALESCE(ir.ir_qty,0) = 0
    ORDER BY i.PurchaseOrder, i.PurchaseOrderItem
    {%- if top != '' %} LIMIT {{ top | int }} {%- endif %}
