version: 1
name: finance.grir.gr_to_ir.final.v13.82.duckdb.fixed_invoice_created_by
description: >
  GRâ†’IR timeliness report (v13.82)
  - Fixed invoice_created_by field (now uses CreatedByUser, not InvoicingParty).
  - Added invoice_vendor_number as separate field.
  - One row per GR (Material Document Item) without aggregation.
  - Includes vendor enrichment, company_name, PO audit fields, and delay logic.

params:
  start_date: "2025-01-01"
  end_date: "2025-10-30"
  vendor: ""
  vendor_query: ""
  delay_threshold_days: 15
  batch_chunk_size: 30
  use_invoice_as_gr: true
  show_only_delayed: true

steps:

# ------------------------------------------------------------
# 1. Supplier Invoice Headers
# ------------------------------------------------------------
- op: fetch
  name: inv_headers
  source: sap
  service: API_SUPPLIERINVOICE_PROCESS_SRV/A_SupplierInvoice
  query_params:
    $format: json
    $select: SupplierInvoice,FiscalYear,PostingDate,CreationDate,
             CompanyCode,InvoiceGrossAmount,DocumentCurrency,InvoicingParty
  odata_filter: >
    {% set sd = start_date %} {% set ed = end_date %}
    PostingDate ge datetime'{{ sd }}T00:00:00' and PostingDate le datetime'{{ ed }}T23:59:59'

# ------------------------------------------------------------
# 2. Supplier Invoice Items
# ------------------------------------------------------------
- op: fetch
  name: inv_items_raw
  source: sap
  service: API_SUPPLIERINVOICE_PROCESS_SRV/A_SuplrInvcItemPurOrdRef
  query_params:
    $format: json
    $select: SupplierInvoice,FiscalYear,SupplierInvoiceItem,PurchaseOrder,
             PurchaseOrderItem,SupplierInvoiceItemAmount,DocumentCurrency,
             QuantityInPurchaseOrderUnit,Plant

# ------------------------------------------------------------
# 3. Purchase Order Header
# ------------------------------------------------------------
- op: fetch
  name: po_header
  source: sap
  service: API_PURCHASEORDER_PROCESS_SRV/A_PurchaseOrder
  query_params:
    $format: json
    $select: PurchaseOrder,CompanyCode,PurchasingGroup,PurchaseOrderDate,
             CreationDate,CreatedByUser,LastChangeDateTime,Supplier

# ------------------------------------------------------------
# 4. Purchase Order Item
# ------------------------------------------------------------
- op: fetch
  name: po_item
  source: sap
  service: API_PURCHASEORDER_PROCESS_SRV/A_PurchaseOrderItem
  query_params:
    $format: json
    $select: PurchaseOrder,PurchaseOrderItem,Material,PurchaseOrderItemText,
             Plant,OrderQuantity

# ------------------------------------------------------------
# 5. Material Document Header + Item
# ------------------------------------------------------------
- op: fetch
  name: matdoc_header
  source: sap
  service: API_MATERIAL_DOCUMENT_SRV/A_MaterialDocumentHeader
  query_params:
    $format: json
    $select: MaterialDocument,PostingDate

- op: fetch
  name: matdoc_item
  source: sap
  service: API_MATERIAL_DOCUMENT_SRV/A_MaterialDocumentItem
  query_params:
    $format: json
    $select: MaterialDocument,MaterialDocumentItem,PurchaseOrder,
             PurchaseOrderItem,QuantityInBaseUnit,QuantityInEntryUnit

# ------------------------------------------------------------
# 6. Business Partner (Vendor)
# ------------------------------------------------------------
- op: fetch
  name: bp_master
  source: sap
  service: API_BUSINESS_PARTNER/A_BusinessPartner
  query_params:
    $format: json
    $select: BusinessPartner,BusinessPartnerFullName,OrganizationBPName1,OrganizationBPName2
  odata_filter: >
    (BusinessPartner ne '')

# ------------------------------------------------------------
# 7. Join Material Docs (Header + Item)
# ------------------------------------------------------------
- op: join
  name: matdoc_joined
  left: matdoc_item
  right: matdoc_header
  left_on: [MaterialDocument]
  right_on: [MaterialDocument]
  type: left

- op: sql
  name: matdoc_gr_rows
  sql: |
    SELECT
      MaterialDocument,
      PurchaseOrder,
      PurchaseOrderItem,
      MaterialDocumentItem,
      COALESCE(
        TRY_CAST(QuantityInBaseUnit AS DOUBLE),
        TRY_CAST(QuantityInEntryUnit AS DOUBLE),
        0.0
      ) AS gr_qty,
      CASE
        WHEN PostingDate IS NULL THEN NULL
        WHEN PostingDate LIKE '/Date(%' THEN DATE(CAST((CAST(REGEXP_REPLACE(PostingDate,'[^0-9]','') AS BIGINT)/1000) AS TIMESTAMP))
        ELSE TRY_CAST(PostingDate AS DATE)
      END AS matdoc_posting_date
    FROM matdoc_joined
    WHERE PurchaseOrder IS NOT NULL AND PurchaseOrder <> ''

# ------------------------------------------------------------
# 8. Deduplicate invoice items
# ------------------------------------------------------------
- op: sql
  name: inv_items_dedup
  sql: |
    SELECT *
    FROM (
      SELECT *,
             ROW_NUMBER() OVER (
               PARTITION BY SupplierInvoice,FiscalYear,PurchaseOrder,PurchaseOrderItem
               ORDER BY SupplierInvoiceItem
             ) AS rn
      FROM inv_items_raw
    )
    WHERE rn = 1

# ------------------------------------------------------------
# 9. Join All Sources
# ------------------------------------------------------------
- op: join
  name: inv_item_hdr
  left: inv_items_dedup
  right: inv_headers
  left_on: [SupplierInvoice, FiscalYear]
  right_on: [SupplierInvoice, FiscalYear]
  type: left

- op: join
  name: inv_po_hdr
  left: inv_item_hdr
  right: po_header
  left_on: [PurchaseOrder]
  right_on: [PurchaseOrder]
  type: left

- op: join
  name: inv_po_item
  left: inv_po_hdr
  right: po_item
  left_on: [PurchaseOrder, PurchaseOrderItem]
  right_on: [PurchaseOrder, PurchaseOrderItem]
  type: left

- op: join
  name: inv_with_matdoc
  left: inv_po_item
  right: matdoc_gr_rows
  left_on: [PurchaseOrder, PurchaseOrderItem]
  right_on: [PurchaseOrder, PurchaseOrderItem]
  type: left

- op: join
  name: inv_with_vendor
  left: inv_with_matdoc
  right: bp_master
  left_on: [Supplier]
  right_on: [BusinessPartner]
  type: left

# ------------------------------------------------------------
# 10. Derive Fields (Fixed invoice_created_by)
# ------------------------------------------------------------
- op: derive
  name: inv_enriched
  from: inv_with_vendor
  add:
    - name: invoice_id
      sql: "SupplierInvoice || '/' || FiscalYear"
    - name: invoice_amount
      sql: "COALESCE(CAST(SupplierInvoiceItemAmount AS DOUBLE), 0.0)"
    - name: ir_posting_date
      sql: >
        CASE
          WHEN PostingDate LIKE '/Date(%' THEN
            DATE(CAST((CAST(REGEXP_REPLACE(PostingDate,'[^0-9]','') AS BIGINT)/1000) AS TIMESTAMP))
          ELSE TRY_CAST(PostingDate AS DATE)
        END
    - name: gr_posting_date
      sql: "TRY_CAST(matdoc_posting_date AS DATE)"
    - name: difference_in_days
      sql: >
        CASE
          WHEN gr_posting_date IS NULL OR ir_posting_date IS NULL THEN NULL
          ELSE DATE_DIFF('day', gr_posting_date, ir_posting_date)
        END
    - name: is_delayed
      sql: >
        CASE
          WHEN difference_in_days > {{ delay_threshold_days }} THEN 'DELAYED'
          WHEN difference_in_days IS NULL THEN 'UNKNOWN'
          ELSE 'ON_TIME'
        END
    - name: po_created_by
      sql: "COALESCE(CreatedByUser, '')"
    - name: po_changed_by
      sql: "COALESCE(CreatedByUser, '')"
    - name: dateandtime
      sql: >
        CASE
          WHEN LastChangeDateTime LIKE '/Date(%' THEN
            CAST((CAST(REGEXP_REPLACE(LastChangeDateTime,'[^0-9]','') AS BIGINT)/1000) AS TIMESTAMP)
          ELSE TRY_CAST(LastChangeDateTime AS TIMESTAMP)
        END
    - name: vendor_number
      sql: "Supplier"
    - name: vendor_name
      sql: >
        COALESCE(BusinessPartnerFullName, OrganizationBPName1, OrganizationBPName2, Supplier)
    - name: company_name
      sql: >
        COALESCE(BusinessPartnerFullName, OrganizationBPName1, OrganizationBPName2, CompanyCode)
    - name: ir_qty
      sql: "COALESCE(TRY_CAST(QuantityInPurchaseOrderUnit AS DOUBLE), NULL)"
    - name: invoice_vendor_number
      sql: "COALESCE(InvoicingParty, '')"
    - name: invoice_created_by
      sql: "COALESCE(CreatedByUser, 'SYSTEM')"
    - name: invoice_created_date
      sql: >
        CASE
          WHEN CreationDate LIKE '/Date(%' THEN
            CAST((CAST(REGEXP_REPLACE(CreationDate,'[^0-9]','') AS BIGINT)/1000) AS TIMESTAMP)
          ELSE TRY_CAST(CreationDate AS TIMESTAMP)
        END

# ------------------------------------------------------------
# 11. Filter + Final Output
# ------------------------------------------------------------
- op: filter
  name: inv_filtered
  from: inv_enriched
  where: >
    ir_posting_date IS NOT NULL
    AND gr_posting_date IS NOT NULL
    {% if show_only_delayed %}
    AND difference_in_days > {{ delay_threshold_days }}
    {% endif %}

- op: select
  name: final_output
  from: inv_filtered
  columns:
    - "CompanyCode AS company_code"
    - "company_name AS company_name"
    - "Plant AS plant_code"
    - "PurchasingGroup AS purchasing_group"
    - "vendor_number AS vendor_number"
    - "vendor_name AS vendor_name"
    - "PurchaseOrder AS po_number"
    - "Material AS material_code"
    - "PurchaseOrderItemText AS material_name"
    - "PurchaseOrderItem AS line_item_no"
    - "MaterialDocument AS material_document"
    - "MaterialDocumentItem AS material_document_item"
    - "OrderQuantity AS qty_po_line"
    - "gr_posting_date AS gr_posting_date"
    - "ir_posting_date AS ir_posting_date"
    - "difference_in_days AS difference_in_days"
    - "is_delayed AS is_delayed"
    - "po_created_by AS po_created_by"
    - "po_changed_by AS po_changed_by"
    - "dateandtime AS dateandtime"
    - "invoice_created_by AS invoice_created_by"

project:
  wrap: true
  projection:
    result:
      final_output:
        from: final_output
