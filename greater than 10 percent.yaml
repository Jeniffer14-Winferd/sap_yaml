#Find GRIR entries where invoice value >10% over PO value

version: 1
name: finance.grir_ir_over_po_10pct.v1.duckdb
description: >
  Find GRIR entries (Posted GR & Posted IR) where the Invoice Value (from SupplierInvoiceItemAmount) exceeds the PO Value by more than 10%. Includes Vendor Name and Company Name.

params:
  vendor: "" # optional vendor ID (e.g., 1000000250)
  vendor_query: "" # optional vendor name contains (case-insensitive)
  po: "" # optional PO filter
  plant: "" # optional plant filter
  company_code: "" # optional company code filter (e.g. BC01)
  start_posting_date: "" # optional (YYYY-MM-DD) – applied to GR/IR posting dates
  end_posting_date: "" # optional (YYYY-MM-DD)
  top: "" # optional LIMIT

steps:

# ---------------------------------------------------------
# 1) Purchase Order Items + Header
# ---------------------------------------------------------
- op: fetch
  name: po_items_raw
  source: sap
  service: API_PURCHASEORDER_PROCESS_SRV/A_PurchaseOrderItem
  query_params:
    $format: json
    $select: >
      PurchaseOrder,PurchaseOrderItem,Plant,Material, PurchaseOrderItemText,DocumentCurrency,OrderQuantity, NetPriceAmount,NetPriceQuantity
    $orderby: PurchaseOrder,PurchaseOrderItem

- op: fetch
  name: po_header_raw
  source: sap
  service: API_PURCHASEORDER_PROCESS_SRV/A_PurchaseOrder
  query_params:
    $format: json
    $select: PurchaseOrder,Supplier,DocumentCurrency,CompanyCode

# ---------------------------------------------------------
# 2) Vendor Name (Supplier master + BP fallback) and Company Name
# ---------------------------------------------------------
- op: fetch
  name: supplier_raw
  source: sap
  service: API_BUSINESS_PARTNER/A_Supplier
  query_params:
    $format: json
    $select: Supplier,SupplierName

- op: fetch
  name: bp_raw
  source: sap
  service: API_BUSINESS_PARTNER/A_BusinessPartner
  query_params:
    $format: json
    $select: BusinessPartner,BusinessPartnerName

- op: sql
  name: vendor_names
  sql: |
    WITH s AS (
      SELECT LPAD(CAST(Supplier AS VARCHAR),10,'0') AS Key10,
             NULLIF(SupplierName,'') AS SupplierName
      FROM supplier_raw
    ),
    b AS (
      SELECT LPAD(CAST(BusinessPartner AS VARCHAR),10,'0') AS Key10,
             MAX(NULLIF(BusinessPartnerName,'')) AS BPName
      FROM bp_raw
      GROUP BY 1
    )
    SELECT
      COALESCE(s.Key10,b.Key10)         AS Key10,
      COALESCE(s.SupplierName,b.BPName) AS VendorName
    FROM s
    FULL OUTER JOIN b ON s.Key10 = b.Key10

- op: fetch
  name: company_raw
  source: sap
  service: API_COMPANYCODE_SRV/A_CompanyCode
  query_params:
    $format: json
    $select: CompanyCode,CompanyCodeName

# ---------------------------------------------------------
# 3) Normalize PO (unit price & PO value) + Vendor/Company join
# ---------------------------------------------------------
- op: sql
  name: po_items
  sql: |
    SELECT
      i.PurchaseOrder,
      i.PurchaseOrderItem,
      h.Supplier AS Vendor,
      vn.VendorName,
      h.CompanyCode,
      c.CompanyCodeName AS CompanyName,
      i.Plant,
      i.Material,
      i.PurchaseOrderItemText AS MaterialName,
      COALESCE(i.DocumentCurrency, h.DocumentCurrency) AS PO_Currency,
      CAST(i.OrderQuantity AS DOUBLE) AS po_qty,
      CASE WHEN TRY_CAST(i.NetPriceQuantity AS DOUBLE) <> 0
           THEN CAST(i.NetPriceAmount AS DOUBLE) / CAST(i.NetPriceQuantity AS DOUBLE)
      END AS po_unit_price,
      CAST(i.OrderQuantity AS DOUBLE) *
        (CAST(i.NetPriceAmount AS DOUBLE) / NULLIF(CAST(i.NetPriceQuantity AS DOUBLE),0)) AS po_value
    FROM po_items_raw i
    LEFT JOIN po_header_raw h
      ON i.PurchaseOrder = h.PurchaseOrder
    LEFT JOIN vendor_names vn
      ON LPAD(CAST(h.Supplier AS VARCHAR),10,'0') = vn.Key10
    LEFT JOIN company_raw c
      ON h.CompanyCode = c.CompanyCode
    WHERE 1=1
      {%- if po != '' %}           AND i.PurchaseOrder = '{{ po }}' {%- endif %}
      {%- if plant != '' %}        AND i.Plant = '{{ plant }}' {%- endif %}
      {%- if vendor != '' %}       AND LPAD(CAST(h.Supplier AS VARCHAR),10,'0') = LPAD('{{ vendor }}',10,'0') {%- endif %}
      {%- if vendor_query != '' %} AND LOWER(vn.VendorName) LIKE '%' || LOWER('{{ vendor_query }}') || '%' {%- endif %}
      {%- if company_code != '' %} AND h.CompanyCode = '{{ company_code }}' {%- endif %}

# ---------------------------------------------------------
# 4) Goods Receipts (GR) – quantities & posting date
# ---------------------------------------------------------
- op: fetch
  name: gr_item_raw
  source: sap
  service: API_MATERIAL_DOCUMENT_SRV/A_MaterialDocumentItem
  query_params:
    $format: json
    $select: >
      MaterialDocument,MaterialDocumentYear,PurchaseOrder,PurchaseOrderItem, GoodsMovementType,GoodsMovementIsCancelled,QuantityInBaseUnit,Plant,Material

- op: fetch
  name: gr_header_raw
  source: sap
  service: API_MATERIAL_DOCUMENT_SRV/A_MaterialDocumentHeader
  query_params:
    $format: json
    $select: MaterialDocument,MaterialDocumentYear,PostingDate

- op: sql
  name: gr_valid
  sql: |
    SELECT
      gi.PurchaseOrder,
      gi.PurchaseOrderItem,
      TRY_CAST(gh.PostingDate AS DATE) AS PostingDate,
      CAST(gi.QuantityInBaseUnit AS DOUBLE) AS qty_gr,
      gi.MaterialDocument AS gr_number
    FROM gr_item_raw gi
    JOIN gr_header_raw gh
      ON gi.MaterialDocument = gh.MaterialDocument
     AND gi.MaterialDocumentYear = gh.MaterialDocumentYear
    WHERE gi.GoodsMovementIsCancelled = 'false'
      AND gi.GoodsMovementType IN ('101','103','105')
      {%- if start_posting_date != '' %} AND TRY_CAST(gh.PostingDate AS DATE) >= DATE '{{ start_posting_date }}' {%- endif %}
      {%- if end_posting_date   != '' %} AND TRY_CAST(gh.PostingDate AS DATE) <= DATE '{{ end_posting_date }}'   {%- endif %}

- op: sql
  name: gr_agg
  sql: |
    SELECT
      PurchaseOrder,
      PurchaseOrderItem,
      SUM(qty_gr) AS gr_qty,
      MAX(PostingDate) AS latest_gr_posting,
      MAX(gr_number) AS gr_number,
      CASE WHEN SUM(qty_gr) > 0 THEN 'Posted' ELSE 'Not Posted' END AS gr_status
    FROM gr_valid
    GROUP BY 1,2

# ---------------------------------------------------------
# 5) Invoice Receipts (IR) — qty + ME23N Amount (SupplierInvoiceItemAmount)
# ---------------------------------------------------------
- op: fetch
  name: ir_item_raw
  source: sap
  service: API_SUPPLIERINVOICE_PROCESS_SRV/A_SuplrInvcItemPurOrdRef
  query_params:
    $format: json
    $select: >
      SupplierInvoice,FiscalYear,PurchaseOrder,PurchaseOrderItem, SupplierInvoiceItemAmount,QuantityInPurchaseOrderUnit,DocumentCurrency

- op: fetch
  name: ir_header_raw
  source: sap
  service: API_SUPPLIERINVOICE_PROCESS_SRV/A_SupplierInvoice
  query_params:
    $format: json
    $select: SupplierInvoice,FiscalYear,PostingDate,CompanyCode

- op: sql
  name: ir_agg
  sql: |
    SELECT
      ii.PurchaseOrder,
      ii.PurchaseOrderItem,
      MAX(ih.CompanyCode) AS company_code,
      MAX(ih.FiscalYear)  AS fiscal_year,
      MAX(ii.SupplierInvoice) AS ir_number,
      SUM(CAST(ii.QuantityInPurchaseOrderUnit AS DOUBLE)) AS ir_qty,
      SUM(CAST(ii.SupplierInvoiceItemAmount AS DOUBLE))   AS ir_value,
      MAX(TRY_CAST(ih.PostingDate AS DATE)) AS latest_ir_posting,
      CASE WHEN SUM(CAST(ii.QuantityInPurchaseOrderUnit AS DOUBLE)) > 0
           THEN 'Posted' ELSE 'Not Posted'
      END AS invoice_status
    FROM ir_item_raw ii
    JOIN ir_header_raw ih
      ON ii.SupplierInvoice = ih.SupplierInvoice
     AND ii.FiscalYear      = ih.FiscalYear
    WHERE 1=1
      {%- if start_posting_date != '' %} AND TRY_CAST(ih.PostingDate AS DATE) >= DATE '{{ start_posting_date }}' {%- endif %}
      {%- if end_posting_date   != '' %} AND TRY_CAST(ih.PostingDate AS DATE) <= DATE '{{ end_posting_date }}'   {%- endif %}
      {%- if company_code != '' %}       AND ih.CompanyCode = '{{ company_code }}' {%- endif %}
    GROUP BY 1,2

# ---------------------------------------------------------
# 6) Result — only IR > 110% of PO
# ---------------------------------------------------------
- op: sql
  name: result
  sql: |
    SELECT
      p.CompanyCode            AS "Company Code",
      p.CompanyName            AS "Company Name",
      p.Plant                  AS "Plant",
      p.Vendor                 AS "Vendor",
      p.VendorName             AS "Vendor Name",
      p.PurchaseOrder          AS "PO Number",
      p.PurchaseOrderItem      AS "PO Item",
      p.Material               AS "Material",
      p.MaterialName           AS "Material Name",
      p.po_qty                 AS "PO Qty",
      p.po_value               AS "PO Value",
      p.PO_Currency            AS "Currency",
      g.gr_qty                 AS "GR Qty",
      i.ir_qty                 AS "IR Qty",
      (g.gr_qty - i.ir_qty)    AS "Qty Diff",
      CASE WHEN p.po_unit_price IS NOT NULL
           THEN g.gr_qty * p.po_unit_price
      END                      AS "GR Value",
      i.ir_value               AS "IR Value",
      (i.ir_value - p.po_value) AS "GRIR Value Diff",
      ROUND(((i.ir_value / NULLIF(p.po_value,0)) - 1) * 100, 2) AS "IR vs PO % Over",
      g.gr_status              AS "GR Status",
      i.invoice_status         AS "Invoice Status",
      g.gr_number              AS "GR Number",
      i.ir_number              AS "IR Number",
      g.latest_gr_posting      AS "GR Posting Date",
      i.latest_ir_posting      AS "Invoice Posting Date"
    FROM po_items p
    LEFT JOIN gr_agg g
      ON p.PurchaseOrder = g.PurchaseOrder
     AND p.PurchaseOrderItem = g.PurchaseOrderItem
    LEFT JOIN ir_agg i
      ON p.PurchaseOrder = i.PurchaseOrder
     AND p.PurchaseOrderItem = i.PurchaseOrderItem
    WHERE g.gr_status = 'Posted'
      AND i.invoice_status = 'Posted'
      AND i.ir_value > (p.po_value * 1.10)
    ORDER BY
      (i.ir_value - p.po_value) DESC,
      p.PurchaseOrder, p.PurchaseOrderItem
    {%- if top != '' %} LIMIT {{ top | int }} {%- endif %}
